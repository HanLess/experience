整体项目描述

#### 业务场景：

根据用户选择范围，生成范围内精度最大的地图图片，内容包括楼盘数据与周边配套数据

#### 关键点：

用户选择范围通常 3-5公里 边长的矩形，没有任何浏览器窗口能够承载此范围大精度的地图内容，所以加载地图后，一次截取所有地图内容行不通，只能每次截取一块，截取多次后拼接成完整的高精度地图图片

#### 无法在客户端做：

（1）在客户端只能通过地图的 canvas 生成图片，但楼盘与周边配套数据，是以 marker 点位的形式标记在地图上，marker 并不是 canvas 生成的，而是普通 dom ，所有 canvas 行不通，只能通过整体截屏的方式进行截图，客户端行不通

（2）地图范围大，生成的图片也大，就算可以通过客户端 canvas 做，也会有严重的性能问题，经试验，一张标准尺寸的地图创建过程中，将占用 40% 左右的 cpu 资源 和 1G 左右的内存资源

（3）服务的优化空间，服务端在生成地图图片的过程，有足够的优化空间，如多进程切图，子进程拼图

#### 实现方式

根据用户框选范围，计算截图路径，node 层根据路径，重复 （截图 -> 移动），得到一系列图片单元，在截图的过程中，实现边截边拼，截图过程结束，拼接同时结束

#### 优化历程

初版：单进程截图，所有图片单元截取完成，再在主进程进行拼接。
缺点：生成图片时间长，并发高的时候非常容易造成 CPU，内存同时打满，对主进程业务造成阻塞

终版：
（1）拼接过程是 CPU 密集型业务，逻辑剥离到子进程，以保证主进程的及时响应
（2）截图，拼图过程都将大量消耗内存、CPU 资源，经压测，20个并发任务就可以把 4核、6G 的测试机打满，所以实现了任务队列，保证最多只有 40 个任务在同时进行
（3）多进程切图，根据当前内存使用情况，决定开启进程数量，最多开启10条进程并行切图
（4）边切边拼，在内存中拼接，最后只生成一次图片，避免每次拼接都进行文件的读写操作。
