<!DOCTYPE html>
<html>
    <head>
    </head>
    <body>
        <video id="myVideo" src="" controls autoplay></video>

        <script src="myFetch.js"></script>
        <script src="mp4-reader.js"></script>
        <script>
            var video = document.querySelector('video');
            var position = 0 , buffer = null
            
            var assetURL = 'http://localhost:8080/frag_bunny.mp4';
            // Need to be specific for Blink regarding codecs
            // ./mp4info frag_bunny.mp4 | grep Codec
            var mimeCodec = 'video/mp4; codecs="avc1.42E01E, mp4a.40.2"';

            var mediaSource = new MediaSource();
            //console.log(mediaSource.readyState); // closed
            video.src = URL.createObjectURL(mediaSource);
            mediaSource.addEventListener('sourceopen', sourceOpen);

            function sourceOpen () {
                //console.log(this.readyState); // open
                var mediaSource = this;
                var sourceBuffer = mediaSource.addSourceBuffer(mimeCodec);
                myFetch(assetURL, function (buf) {
                    buffer = new Uint8Array(buf);
                    var typeBuffer = []
                    console.log(buffer)
                    var reader = new mp4Reader(buffer);
                    console.log(reader)
                    
                    sourceBuffer.addEventListener('updateend', function (_) {
                        mediaSource.endOfStream();
                    });
                    sourceBuffer.appendBuffer(buf);
                });
            };
        </script>
    </body>
</html>