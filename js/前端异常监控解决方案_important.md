<a href="https://mp.weixin.qq.com/s/W0i-Iu6nqkWttsGZ-RmOqw">腾讯CDC团队：前端异常监控解决方案</a>

以上方案非常优秀，这里总结一下

## 采集的内容

- 用户
- 动作
- 异常
- 环境信息

异常分类

<img src="https://github.com/HanLess/experience/blob/master/js/imgs/%E5%89%8D%E7%AB%AF%E5%BC%82%E5%B8%B8%E5%88%86%E7%B1%BB.png" />

## 异常捕获方法

全局捕获

- vue，react 有自带的异常捕获方案
- window.addEventListener('error') 可作为兜底方案

单点捕获

- try...catch... 捕获
- 封装好捕获的方法

在捕获阶段，还是要尽量全局捕获，减少侵入性，当大量的监控代码分布在业务代码中，会造成更多的问题，违背了初衷，且通用性差，所以单点捕获只能作为全局捕获的补充，由技术人员自觉插入

## 异常录制

录制用户的动作，这里很重要，是接下来处理异常的依据，但如何实现用户动作的录制，值得深入思考，todo

## 异常分级

如何给异常自动分级？还是说只能手动指定异常级别

## 上报

### 本地存储

不可能所有的用户动作都上报，需要在本地存储、处理、筛选，以下是本地存储的解决方案

<img src="https://github.com/HanLess/experience/blob/master/js/imgs/%E5%89%8D%E7%AB%AF%E6%8C%81%E4%B9%85%E5%8C%96%E6%96%B9%E6%A1%88.png" />

本地存储后，使用 web worker 处理数据、上报异常，但要注意 web worker 的浏览器兼容性，并做好兼容处理

### 上传

- 可以根据异常级别分为 立即上传 、 批量上传 等，根据自己的业务需求也可以有其他上传方案
- 要有确认机制，在上传失败后，要重复上传，所以这里就只能是通过后端接口的形式上传，传统的发送log -> 在 log 中捞取数据的方法不可用
- 需要在上传前压缩内容，否则体积过大，可采取 lz-string 或 gzip 等前端压缩方案

## 服务端接收、存储、统计、分析、报警

略

## 修复

线上的 js 代码都是经过混淆压缩的，需要在监控系统中部署 sourcemap，解码相关的 js，注意这里 sourcemap 版本要跟线上 js 严格一致，关于 sourcemap 解压缩的方案可以研究一下


## 总结

前端监控主要包括 用户行为监控（打点）、异常监控、性能监控。这里的异常监控提供了一个思路，另外两种监控只不过是上报的内容不同，但数据收集、上报方案完全可以通用







